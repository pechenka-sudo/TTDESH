<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini Geometry Dash — с меню</title>
<style>
  body, html {
    margin:0; padding:0; height:100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #4e54c8, #8f94fb);
    overflow: hidden;
    user-select: none;
  }
  #app {
    max-width: 480px;
    margin: auto;
    padding: 20px;
    background: #fafafa;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
  }
  h1 {
    text-align: center;
    color: #333;
  }
  input[type=email], input[type=password] {
    width: 100%;
    padding: 12px;
    margin: 8px 0 14px 0;
    border-radius: 10px;
    border: 2px solid #4e54c8;
    font-size: 16px;
    outline-offset: 2px;
    outline-color: #6f75f9;
    transition: border-color 0.3s ease;
  }
  input[type=email]:focus, input[type=password]:focus {
    border-color: #6f75f9;
  }
  button {
    width: 100%;
    padding: 14px 0;
    margin-top: 14px;
    border-radius: 14px;
    font-weight: 700;
    font-size: 16px;
    border: none;
    background: #4e54c8;
    color: #fff;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  button:hover:not(:disabled) {
    background-color: #3b3f9b;
  }
  button:disabled {
    background-color: #a4a8f5;
    cursor: default;
  }
  .error {
    color: #d33;
    font-weight: 600;
    min-height: 22px;
    margin-bottom: 10px;
    text-align: center;
  }
  #gameScreen, #menuScreen {
    display: none;
    flex-direction: column;
    align-items: center;
  }
  #score {
    font-size: 24px;
    font-weight: 700;
    margin: 12px 0;
    color: #333;
  }
  #gameCanvas {
    background: #222;
    border-radius: 15px;
    box-shadow: 0 0 15px #666;
    touch-action: manipulation;
  }
  #playAgainBtn {
    margin-top: 20px;
    background: #d54242;
    border-radius: 14px;
  }
  #logoutBtn {
    margin-top: 10px;
    background: #777;
  }
  /* Меню стили */
  #menuScreen {
    animation: fadeInSlide 0.6s ease forwards;
    width: 100%;
  }
  #menuScreen h2 {
    color: #444;
    margin-bottom: 18px;
    font-size: 28px;
    text-align: center;
    font-weight: 700;
  }
  #menuScreen button {
    max-width: 280px;
    margin: 10px auto;
    padding: 14px 0;
    font-size: 18px;
    border-radius: 20px;
    background: linear-gradient(135deg, #6f75f9, #4e54c8);
    box-shadow: 0 6px 15px rgba(78,84,200,0.6);
    transition: background 0.4s ease;
  }
  #menuScreen button:hover {
    background: linear-gradient(135deg, #4e54c8, #6f75f9);
  }
  @keyframes fadeInSlide {
    0% {
      opacity: 0;
      transform: translateY(20px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
</head>
<body>
  <div id="app">
    <div id="authScreen">
      <h1>Mini Geometry Dash</h1>
      <input type="email" id="emailInput" placeholder="Email" autocomplete="username" />
      <input type="password" id="passwordInput" placeholder="Пароль" autocomplete="current-password" />
      <div class="error" id="authError"></div>
      <button id="signInBtn">Войти</button>
      <button id="signUpBtn">Регистрация</button>
    </div>

    <div id="menuScreen">
      <h2>Привет, <span id="userEmailMenu"></span>!</h2>
      <button id="startGameBtn">Старт</button>
      <button id="levelsBtn" disabled>Уровни (скоро)</button>
      <button id="logoutBtnMenu">Выйти</button>
    </div>

    <div id="gameScreen">
      <div id="score">Очки: 0</div>
      <canvas id="gameCanvas" width="480" height="320"></canvas>
      <button id="playAgainBtn" style="display:none;">Играть снова</button>
      <button id="logoutBtnGame">Выйти</button>
    </div>
  </div>

  <!-- Рекламный баннер -->
  <div style="position: absolute; z-index: 99999">
    <input autocomplete="off" type="checkbox" id="aadsstickyme80rm2l" hidden />
    <div style="padding-top: 0; padding-bottom: auto;">
      <div style="width:100%;height:auto;position:fixed;text-align:center;font-size:0;bottom:0;left:0;right:0;margin:auto">
        <label for="aadsstickyme80rm2l" style="top: 50%;transform: translateY(-50%);right:24px;; position: absolute;border-radius: 4px; background: rgba(248, 248, 249, 0.7); padding: 4px;z-index: 99999;cursor:pointer">
          <svg fill="#000000" height="16px" width="16px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 490 490">
            <polygon points="456.851,0 245,212.564 33.149,0 0.708,32.337 212.669,245.004 0.708,457.678 33.149,490 245,277.443 456.851,490 489.292,457.678 277.331,245.004 489.292,32.337 "/>
          </svg>
        </label>
        <div id="frame" style="width: 100%;margin: auto;background: rgba(0, 0, 0, 0.5);position: relative; z-index: 99998;">
          <iframe data-aa=2406373 src=//acceptable.a-ads.com/2406373/?size=Adaptive style='border:0; padding:0; width:70%; height:auto; overflow:hidden; margin: auto'></iframe>
        </div>
      </div>
      <style>
        #aadsstickyme80rm2l:checked + div {
          display: none;
        }
      </style>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCXfzRrHa2t-y5TBJoipN0m_mv9bXjHmL8",
      authDomain: "golden-mine-e7d50.firebaseapp.com",
      databaseURL: "https://golden-mine-e7d50-default-rtdb.firebaseio.com",
      projectId: "golden-mine-e7d50",
      storageBucket: "golden-mine-e7d50.firebasestorage.app",
      messagingSenderId: "49056047000",
      appId: "1:49056047000:web:76e20efa45a0b8ffc415ed",
      measurementId: "G-MMD56ZP5YE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // DOM Elements
    const authScreen = document.getElementById('authScreen');
    const menuScreen = document.getElementById('menuScreen');
    const gameScreen = document.getElementById('gameScreen');

    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const signInBtn = document.getElementById('signInBtn');
    const signUpBtn = document.getElementById('signUpBtn');
    const authError = document.getElementById('authError');

    const userEmailMenu = document.getElementById('userEmailMenu');

    const logoutBtnMenu = document.getElementById('logoutBtnMenu');
    const logoutBtnGame = document.getElementById('logoutBtnGame');

    const startGameBtn = document.getElementById('startGameBtn');
    const levelsBtn = document.getElementById('levelsBtn');

    const scoreEl = document.getElementById('score');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const playAgainBtn = document.getElementById('playAgainBtn');

    // Game vars
    let gameRunning = false;
    let score = 0;
    let speed = 4;
    let player = {
      x: 50, y: 260, w: 40, h: 40,
      vy: 0, gravity: 1.2,
      jumpForce: -18,
      onGround: false
    };
    let obstacles = [];
    let obstacleFrequency = 90; // frames between obstacles
    let frameCount = 0;
    let gameOver = false;

    // WebAudio for sounds
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(freq, duration = 0.1, type = 'square') {
      const osc = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      osc.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      osc.type = type;
      osc.frequency.value = freq;
      gainNode.gain.setValueAtTime(0.12, audioCtx.currentTime);
      osc.start();
      osc.stop(audioCtx.currentTime + duration);
    }

    function playJump() {
      playSound(600, 0.1, 'triangle');
    }
    function playHit() {
      playSound(150, 0.2, 'sawtooth');
    }
    function playClick() {
      playSound(900, 0.05, 'sine');
    }

    // Create obstacles
    function createObstacle() {
      const height = 30 + Math.random() * 30;
      obstacles.push({
        x: canvas.width,
        y: canvas.height - height - 20,
        w: 20,
        h: height
      });
    }

    function updateGame() {
      if (gameOver) return;

      // Player physics
      player.vy += player.gravity;
      player.y += player.vy;

      // Ground check
      if (player.y + player.h > canvas.height - 20) {
        player.y = canvas.height - 20 - player.h;
        player.vy = 0;
        player.onGround = true;
      } else {
        player.onGround = false;
      }

      // Move obstacles left
      for (let i = obstacles.length -1; i >= 0; i--) {
        obstacles[i].x -= speed;
        if (obstacles[i].x + obstacles[i].w < 0) {
          obstacles.splice(i,1);
          score++;
          scoreEl.textContent = 'Очки: ' + score;
          if(score % 5 === 0) speed += 0.5; // ускорение
        }
      }

      // Spawn obstacles
      frameCount++;
      if(frameCount % obstacleFrequency === 0){
        createObstacle();
        if(obstacleFrequency > 30) obstacleFrequency -= 1;
      }

      // Collision check
      for (let ob of obstacles) {
        if (
          player.x < ob.x + ob.w &&
          player.x + player.w > ob.x &&
          player.y < ob.y + ob.h &&
          player.y + player.h > ob.y
        ) {
          gameOver = true;
          playHit();
          endGame();
        }
      }
    }

    function clearScreen() {
      ctx.fillStyle = '#222';
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }

    function drawPlayer() {
      ctx.fillStyle = '#ffcb05';
      ctx.shadowColor = '#ffaa00';
      ctx.shadowBlur = 15;
      ctx.fillRect(player.x, player.y, player.w, player.h);
      ctx.shadowBlur = 0;
    }

    function drawObstacles() {
      ctx.fillStyle = '#e63946';
      ctx.shadowColor = '#a32a2a';
      ctx.shadowBlur = 12;
      obstacles.forEach(ob => {
        ctx.fillRect(ob.x, ob.y, ob.w, ob.h);
      });
      ctx.shadowBlur = 0;
    }

    function gameLoop() {
      if (!gameRunning) return;
      updateGame();
      clearScreen();
      drawPlayer();
      drawObstacles();
      requestAnimationFrame(gameLoop);
    }

    // Jump handler
    function jump() {
      if (player.onGround) {
        player.vy = player.jumpForce;
        playJump();
      }
    }

    window.addEventListener('keydown', e => {
      if (e.code === 'Space' || e.code === 'ArrowUp') {
        e.preventDefault();
        jump();
      }
    });
    canvas.addEventListener('click', jump);
    canvas.addEventListener('touchstart', jump);

    // Auth functions
    signUpBtn.onclick = () => {
      authError.textContent = '';
      const email = emailInput.value.trim();
      const pass = passwordInput.value.trim();
      if (!email || !pass) {
        authError.textContent = 'Введите email и пароль';
        return;
      }
      createUserWithEmailAndPassword(auth, email, pass)
        .then(() => {
          playClick();
        })
        .catch(err => {
          authError.textContent = err.message;
        });
    };

    signInBtn.onclick = () => {
      authError.textContent = '';
      const email = emailInput.value.trim();
      const pass = passwordInput.value.trim();
      if (!email || !pass) {
        authError.textContent = 'Введите email и пароль';
        return;
      }
      signInWithEmailAndPassword(auth, email, pass)
        .then(() => {
          playClick();
        })
        .catch(err => {
          authError.textContent = err.message;
        });
    };

    logoutBtnMenu.onclick = () => {
      signOut(auth);
      playClick();
    };
    logoutBtnGame.onclick = () => {
      signOut(auth);
      playClick();
    };

    startGameBtn.onclick = () => {
      playClick();
      startGame();
    };

    // Auth state change handler
    onAuthStateChanged(auth, user => {
      if (user) {
        authScreen.style.display = 'none';
        menuScreen.style.display = 'flex';
        gameScreen.style.display = 'none';
        userEmailMenu.textContent = user.email;
      } else {
        authScreen.style.display = 'flex';
        menuScreen.style.display = 'none';
        gameScreen.style.display = 'none';
        emailInput.value = '';
        passwordInput.value = '';
        authError.textContent = '';
      }
    });

    // Start game setup
    function startGame() {
      menuScreen.style.display = 'none';
      gameScreen.style.display = 'flex';
      playAgainBtn.style.display = 'none';
      score = 0;
      speed = 4;
      obstacles = [];
      frameCount = 0;
      gameOver = false;
      player.x = 50;
      player.y = 260;
      player.vy = 0;
      player.onGround = false;
      scoreEl.textContent = 'Очки: 0';
      gameRunning = true;
      gameLoop();
    }

    playAgainBtn.onclick = () => {
      playClick();
      startGame();
    };

    function endGame() {
      gameRunning = false;
      playAgainBtn.style.display = 'block';
    }
  </script>
</body>
</html>
